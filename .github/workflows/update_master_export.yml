name: Update Master Story Export

# Trigger: Runs when you push changes to your specific folders
on:
  push:
    branches:
      - main
    paths:
      - '01_CHARACTERS/**'
      - '02_World/**'
      - '03_Arcs/**'
      - '.github/workflows/update_master_export.yml' # Trigger when you edit this file too

permissions:
  contents: write

jobs:
  build-story-export:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Stitch Story Files
        run: |
          OUTPUT_FILE="master_story_export.txt"
          
          # Clear file and add Header
          > $OUTPUT_FILE
          echo "========================================" >> $OUTPUT_FILE
          echo "MASTER STORY EXPORT - GENERATED AUTOMATICALLY" >> $OUTPUT_FILE
          echo "========================================" >> $OUTPUT_FILE
          echo "" >> $OUTPUT_FILE
          
          # 1. Add Characters
          if [ -d "01_CHARACTERS" ]; then
            echo "Processing Characters..."
            for file in 01_CHARACTERS/*.md; do
              [ -e "$file" ] || continue
              echo "----------------------------------------" >> $OUTPUT_FILE
              echo "FILE: $file" >> $OUTPUT_FILE
              echo "----------------------------------------" >> $OUTPUT_FILE
              cat "$file" >> $OUTPUT_FILE
              echo -e "\n\n" >> $OUTPUT_FILE
            done
          fi

          # 2. Add World Building
          if [ -d "02_World" ]; then
            echo "Processing World..."
            for file in 02_World/*.md; do
              [ -e "$file" ] || continue
              echo "----------------------------------------" >> $OUTPUT_FILE
              echo "FILE: $file" >> $OUTPUT_FILE
              echo "----------------------------------------" >> $OUTPUT_FILE
              cat "$file" >> $OUTPUT_FILE
              echo -e "\n\n" >> $OUTPUT_FILE
            done
          fi

          # 3. Add Story Arcs
          if [ -d "03_Arcs" ]; then
            echo "Processing Arcs..."
            for file in 03_Arcs/*.md; do
              [ -e "$file" ] || continue
              echo "----------------------------------------" >> $OUTPUT_FILE
              echo "FILE: $file" >> $OUTPUT_FILE
              echo "----------------------------------------" >> $OUTPUT_FILE
              cat "$file" >> $OUTPUT_FILE
              echo -e "\n\n" >> $OUTPUT_FILE
            done
          fi
          
      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "AUTO: Update master_story_export.txt with new chapters"
          file_pattern: master_story_export.txt